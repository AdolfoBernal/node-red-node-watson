<!--
  Copyright 2018 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="watson-doc-translator">
    <div id="credentials-check" class="form-row">
        <div class="form-tips">
            <i class="fa fa-question-circle"></i><b> Please wait: </b> Checking for bound service credentials...
        </div>
    </div>
    <div id="credentials-not-found" class="form-row" style="display: none;">
        <div class="form-tips">
            <i class="fa fa-question-circle"></i><b> Could not bind to service. </b>
            This node can not be further configured without a valid service.
            Try entering valid credentials?
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row credentials" style="display: none;">
        <label for="node-input-username"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-input-username" placeholder="Username"/>
    </div>
    <div class="form-row credentials" style="display: none;">
        <label for="node-input-password"><i class="fa fa-key"></i> Password</label>
        <input type="password" id="node-input-password" placeholder="Password"/>
    </div>
    <div class="form-row credentials" style="display: none;">
        <label for="node-input-apikey"><i class="fa fa-key"></i> API Key</label>
        <input type="password" id="node-input-apikey" placeholder="API Key"></input>
    </div>

    <div class="form-row credentials">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-default-endpoint" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-default-endpoint" style="width: 70%;"> Use Default Service Endpoint</label>
    </div>
    <div class="form-row">
        <label for="node-input-service-endpoint"><i class="fa fa-tag"></i> Service Endpoint</label>
        <input type="text" id="node-input-service-endpoint" placeholder="https://gateway.watsonplatform.net/language-translator/api">
    </div>

    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-cog"></i> Mode</label>
        <select type="text" id="node-input-action" style="display: inline-block; vertical-align:middle; width: 70%;">
            <option value="translateDocument">translate document</option>
            <option value="listDocuments">list documents</option>
        </select>
    </div>

</script>

<script type="text/x-red" data-help-name="watson-doc-translator">
    <p>The Watson Document Translator Node makes use of the Language
      translator service to translate documents. A list of the supported
      file types can be found
      <a href="https://console.bluemix.net/docs/services/language-translator/translating-documents.html#supported-file-formats">
        here.</a>

    <p><b>Usage</b></p>
    <p>This node should be provided in input : </p>
    <ul>
      <li><code>msg.payload</code> : A stream buffer of the document to convert.
      </li>
    </ul>
    <p>On successful conversion this node will output : </p>
    <ul>
      <li> </li>
    </ul>
    <p>For more information about the Language Translator service, read the
      <a href="https://console.bluemix.net/docs/services/language-translator/index.html">
        documentation</a>.</p>
</script>


<script type="text/javascript">
    // Need to simulate a namespace, so that some of the variables don't leak across nodes
    function DocTranslator () {
    }

    // This is the namespace for document translator.
    var doctor = new DocTranslator();


    doctor.showSelectedFields = function(fields) {
      for (i = 0; i < fields.length; i++) {
        $(fields[i]).parent().show();
      }
    }

    doctor.hideSelectedFields = function(fields) {
      for (i = 0; i < fields.length; i++) {
        $(fields[i]).parent().show();
      }
    }

    // Function to be used at the start, as don't want to expose any fields, unless the model is
    // available. The model it self can only be fetched if the credentials are available.
    //doctor.hideAll = function () {
      //var hideFields = [];
      //var showFields = [];

      //showFields.push('#credentials-not-found');
      //hideFields.push('#node-input-action');
    //}

    // Register the handlers for the fields
    doctor.UIListeners = function () {
      $('#node-input-username').change((val) => {
      });

      $('#node-input-password').change((val) => {
      });

      $('#node-input-apikey').change((val) => {
      });

      $('#node-input-action').change((val) => {
      });

      $('#node-input-default-endpoint').change(() => {
        var checked = $('#node-input-default-endpoint').prop('checked')
        if (checked) {
          $('#node-input-service-endpoint').parent().hide();
        } else {
          $('#node-input-service-endpoint').parent().show();
        }
      });
    }

    doctor.checkCredentials = function() {
      return new Promise(function resolver(resolve, reject){
        $.getJSON('watson-doc-translator/vcap/')
          .done(function (service) {
            $('.credentials').toggle(!service);
          })
          .fail(function () {
            $('.credentials').show();
          }).always(function () {
            $('#credentials-check').hide();
            resolve();
          })
      });
    }

    // This is the on edit prepare function, which will be invoked everytime
    // the dialog is shown.
    function oneditprepare() {
      //doctor.hideAll();
      doctor.UIListeners();
      doctor.checkCredentials()
        .then(() => {
        })
        .catch(function(err){
          console.log('Error in oneditprepare for doc translator node ', err);
        });  
    }

    // Save the values in the dyanmic lists to the hidden fields.
    function oneditsave(){
    }

    (function() {
        RED.nodes.registerType('watson-doc-translator', {
            category: 'IBM Watson',
            defaults: {
                name: {value: ""},
                password: {value: ''},
                apikey: {value: ''},
                action: {value: 'translateDocument'},
                'default-endpoint' :{value: true},
                'service-endpoint' :{value: 'https://gateway.watsonplatform.net/language-translator/api'}
            },
            credentials: {
                username: {type: 'text'}
            },
            color: "rgb(84,149,230)",
            inputs: 1,
            outputs: 1,
            paletteLabel: "document translator",
            icon: "LanguageTranslator25x25.png",
            label: function() {
                return this.name || "document translator";
            },
            labelStyle: function() {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: oneditprepare,
            oneditsave: oneditsave
        });
    })();
</script>
